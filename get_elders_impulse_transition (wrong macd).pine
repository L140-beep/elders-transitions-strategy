//@version=5
indicator("Elder's Impulse Transition Alert", overlay=true)

// === ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ===
string tfInput = input.timeframe("1W", title="Ð¢Ð°Ð¹Ð¼Ñ„Ñ€ÐµÐ¹Ð¼ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°")
bool showCurrentTF = input(true, title="ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ñ‹ Ð½Ð° Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼ Ð¢Ð¤?")
bool showWeeklyTF = input(true, title="ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ñ‹ Ð½Ð° Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¼ Ð¢Ð¤?")

// ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð¾Ð²
emaLength = input(13, title="EMA Length")
macdFast = input(12, title="MACD Fast Length")
macdSlow = input(26, title="MACD Slow Length")
macdSignal = input(9, title="MACD Signal Length")

// === Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð¸Ð¼Ð¿ÑƒÐ»ÑŒÑÐ° ===
// Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ñ‡Ð¸ÑÐ»Ð¾Ð²Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ñ ta.valuewhen()
getImpulseState(close, ema, macdLine, signalLine) =>
    if close > ema and macdLine > signalLine
        1 // LONG
    else if close < ema and macdLine < signalLine
        -1 // SHORT
    else
        0 // NEUTRAL

// === Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ MACD ===
getMACDLine() => 
    [macdLine, _, _] = ta.macd(close, macdFast, macdSlow, macdSignal)
    macdLine

getMACDSignal() =>
    [_, signalLine, _] = ta.macd(close, macdFast, macdSlow, macdSignal)
    signalLine

// === Ð Ð°ÑÑ‡ÐµÑ‚ Ð½Ð° Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼Ñ„Ñ€ÐµÐ¹Ð¼Ðµ ===
currentEMA = ta.ema(close, emaLength)
currentMACD = getMACDLine()
currentSignal = getMACDSignal()
currentState = getImpulseState(close, currentEMA, currentMACD, currentSignal)
prevState = ta.valuewhen(barstate.isconfirmed, currentState[1], 0)

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ‡Ð¸ÑÐ»Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð² ÑÑ‚Ñ€Ð¾ÐºÑƒ
stateToString(state) =>
    state == 1 ? "LONG" : state == -1 ? "SHORT" : "NEUTRAL"

// === Ð Ð°ÑÑ‡ÐµÑ‚ Ð½Ð° Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¼ Ñ‚Ð°Ð¹Ð¼Ñ„Ñ€ÐµÐ¹Ð¼Ðµ ===
weeklyClose = request.security(syminfo.tickerid, tfInput, close)
weeklyEMA = request.security(syminfo.tickerid, tfInput, ta.ema(close, emaLength))
weeklyMACD = request.security(syminfo.tickerid, tfInput, getMACDLine())
weeklySignal = request.security(syminfo.tickerid, tfInput, getMACDSignal())
weeklyState = getImpulseState(weeklyClose, weeklyEMA, weeklyMACD, weeklySignal)

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐ³Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
f_prevState() => 
    var float lastState = 0
    current = getImpulseState(close, ta.ema(close, emaLength), getMACDLine(), getMACDSignal())
    if barstate.isconfirmed
        lastState := current[1]
    lastState

weeklyPrevState = request.security(syminfo.tickerid, tfInput, f_prevState())

// === ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¾Ð² ===
isCurrentLongToNeutral = (prevState == 1 and currentState == 0)
isCurrentShortToNeutral = (prevState == -1 and currentState == 0)

isWeeklyLongToNeutral = (weeklyPrevState == 1 and weeklyState == 0)
isWeeklyShortToNeutral = (weeklyPrevState == -1 and weeklyState == 0)

// === Ð’Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ===
currentColor = isCurrentLongToNeutral ? color.new(color.blue, 70) : isCurrentShortToNeutral ? color.new(color.orange, 70) : na
weeklyColor = isWeeklyLongToNeutral ? color.new(color.blue, 70) : isWeeklyShortToNeutral ? color.new(color.orange, 70) : na


barcolor(showCurrentTF and timeframe.period != "1W" ? currentColor : na)
barcolor(showWeeklyTF and timeframe.period == "1W" ? currentColor : na)
plot(showWeeklyTF ? weeklyEMA : na, "Weekly EMA", color.purple, 2)

// === Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ ===
var table impulseTable = table.new(position.top_right, 2, 3, border_width=1)

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ñ‚ÐµÐºÑÑ‚Ð° Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð°
getTransitionText(isLongToNeutral, isShortToNeutral) =>
    isLongToNeutral ? "ðŸ”µ LONG â†’ NEUTRAL" : isShortToNeutral ? "ðŸŸ  SHORT â†’ NEUTRAL" : "â€”"

